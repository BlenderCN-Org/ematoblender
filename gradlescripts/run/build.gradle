/*
  Script to run the separate elements of the Ematoblender pipeline
  Basically controls the CL options so it can be run with one command.
  - runGameServerStatic and runGameServerLive take CL args RE showing the GUI,
  - runGameServerLive takes a CL arg to set the PORT number for the articulograph
  - runGameServerStatic takes the collection to show, if not the default
  
*/

ext{
  pyAlias = { return new groovy.json.JsonSlurper().parseText(file("$rootProject.buildDir/python.json").text).python.path }
}

// this depends on whether the user wants to use the WAVE or static file
task runDataServer(){
  dependsOn ":gradlescripts:setup:setupEnvironment:setup"
  doLast{
    println "Starting a ProcessBuilder for the data server."
    ProcessBuilder builder = new ProcessBuilder("${pyAlias()} ./ematoblender/dataserver.py -g".split(' '))
    Process p = builder.start()
    }
}
// this must happen in any case
task runGameServerStatic(){
  dependsOn ":gradlescripts:setup:setupEnvironment:setup"
  doLast{
    println "Starting a ProcessBuilder for the static gameserver"
    ProcessBuilder builder = new ProcessBuilder("${pyAlias()} ./ematoblender/gameserver.py -g".split(' '))
    Process g = builder.start()
  }
}

task runGameServerLive(){
  dependsOn ":gradlescripts:setup:setupEnvironment:setup"
  doLast{
    println "Starting a ProcessBuilder for the live gamserver"
    ProcessBuilder builder = new ProcessBuilder("${pyAlias()} ./ematoblender/gameserver.py --host $host --port $port -g".split(' '))
    Process g = builder.start()
  }
}

/*----------------------------------------------------------------------------*/
// tasks that are executed

task run(dependsOn: [runDataServer,runGameServerStatic]){
  doLast{
    println "Running the static data server and gameserver"
  }
}

task runFromWave(){
  dependsOn runGameServerLive

  doLast{
    println "Running the gameserver for live streaming on $host $port"
  }
}
